name: Build and Deploy Nuxeo Benchmarks

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: benchmarks

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Site
      uses: chabad360/hugo-actions@3a5b10adf0b017f695597e22ebcb79e40fd6cb4e #v2
      with:
        buildPath: 'public'
        hugoVersion: 'extended_0.80.0'
        args: --gc --minify --cleanDestinationDir

  deploy:
    runs-on: benchmarks
    needs: build

    steps:
      - name: Rsync to Server
        run: |
          rsync -Waxv --delete ${{ github.workspace }}/public/ root@www:/var/www/nuxeo.com/benchmarks

      - name: Test Nginx Configuration
        run: ssh root@www "nginx -t"

      - name: Reload Nginx
        run: ssh root@www "service nginx reload"
